<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>â›ï¸ Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ù†Ø¬Ù… - Ù…Ø¹ Ù…ØªØ¬Ø± ÙˆØªØ±Ù‚ÙŠØ§Øª</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
<style>
  :root{--bg:#2f2016;--panel:#1f1410;--accent:#ffcc33;}
  body{margin:0;font-family:"Cairo",sans-serif;background:var(--bg);color:#fff;display:flex;flex-direction:column;align-items:center;}
  h2{margin:12px 0;}
  #game { width:100%; max-width:900px; height:70vh; }
  /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØªØ¬Ø± (overlay) */
  .shop-overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,0.6); z-index:999; visibility:hidden;
  }
  .shop {
    width:320px; background:var(--panel); border-radius:12px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,0.6);
    color:#fff; text-align:right;
  }
  .shop h3{margin:0 0 8px 0;}
  .stat{display:flex;justify-content:space-between;margin:8px 0;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .btn {background:var(--accent); color:#000; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;}
  .btn:disabled{opacity:0.5; cursor:not-allowed;}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .hud{position:absolute;left:12px;top:12px;z-index:10;text-align:left}
  .hud div{margin-bottom:6px;background:rgba(0,0,0,0.3);padding:6px 8px;border-radius:8px}
  .weapon-indicator{position:absolute;right:12px;top:12px;z-index:10;text-align:right}
</style>
</head>
<body>
  <h2>â›ï¸ Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ù†Ø¬Ù… - Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØµÙØ­</h2>
  <div id="game"></div>

  <!-- HUD -->
  <div class="hud">
    <div id="scoreBox">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
    <div id="coinsBox">Ø§Ù„Ù†Ù‚ÙˆØ¯: 0</div>
    <div id="levelBox">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: 1</div>
  </div>

  <div class="weapon-indicator" id="weaponBox">Ø§Ù„Ø³Ù„Ø§Ø­: ÙØ£Ø³</div>

  <!-- Shop overlay (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰) -->
  <div class="shop-overlay" id="shopOverlay">
    <div class="shop" role="dialog" aria-modal="true">
      <h3>ğŸª Ù…ØªØ¬Ø± Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª</h3>
      <p id="shopIntro">ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ <span id="shopLevel">1</span>. ÙŠÙ…ÙƒÙ†Ùƒ Ø´Ø±Ø§Ø¡ ØªØ±Ù‚ÙŠØ§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>

      <div class="stat">
        <div>Ø³Ø±Ø¹Ø© Ø§Ù„Ø±Ù…ÙŠ (Ø¶Ø±Ø¨Ø§Øª/Ø«Ø§Ù†ÙŠØ©)</div>
        <div id="fireRateVal">1.0</div>
      </div>
      <div class="row">
        <div>ØªØ±Ù‚ÙŠØ© Ø³Ø±Ø¹Ø© Ø§Ù„Ø±Ù…ÙŠ (+0.5)</div>
        <div><button class="btn" id="buyFireRate">Ø§Ø´ØªØ±Ù - <span id="buyFireRateCost">50</span> ğŸª™</button></div>
      </div>

      <hr style="opacity:0.08;margin:12px 0;">

      <div class="stat">
        <div>Ù†Ù‚ÙˆØ¯ Ù„ÙƒÙ„ ØµØ®Ø±Ø©</div>
        <div id="coinPerRockVal">5</div>
      </div>
      <div class="row">
        <div>ØªØ±Ù‚ÙŠØ© Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ù†Ù‚ÙˆØ¯ (+2)</div>
        <div><button class="btn" id="buyCoinPerRock">Ø§Ø´ØªØ±Ù - <span id="buyCoinPerRockCost">60</span> ğŸª™</button></div>
      </div>

      <hr style="opacity:0.08;margin:12px 0;">

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="skipShop">ØªØ®Ø·ÙŠ Ø§Ù„Ù…ØªØ¬Ø±</button>
        <button class="btn" id="continueGame">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
      </div>
      <p style="font-size:12px;opacity:0.8;margin-top:8px">Ø§Ù„ØªØ±Ù‚ÙŠØ§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (localStorage).</p>
    </div>
  </div>

<script>
/* =========================
  CONFIG â€” Ø¶Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ±/Ø§Ù„Ø£ØµÙˆØ§Øª Ù‡Ù†Ø§
  â€” Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠØ© Ø¶ÙØ¹Ù‡Ø§ ÙÙŠ Ù…Ø¬Ù„Ø¯ images/ Ùˆ sounds/
  â€” Ø£Ù…Ø«Ù„Ø© Ù…Ø³Ø§Ø±Ø§Øª Ù…Ø­Ù„ÙŠØ©: 'images/cart.png' Ø£Ùˆ 'sounds/hit.mp3'
  â€” Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±ÙˆØ§Ø¨Ø· CDN Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
   ========================= */
const ASSETS = {
  background: 'images/background.png', // Ø¶Ø¹ ØµÙˆØ±ØªÙƒ Ù‡Ù†Ø§ Ø£Ùˆ Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ
  cart:       'images/cart.png',
  rock:       'images/rock.png',
  pickaxe:    'images/pickaxe.png',
  dynamite:   'images/dynamite.png',
  explosion:  'images/explosion.png', // Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ø³ÙŠØ³ØªØ®Ø¯Ù… Ø£ÙŠØ¶Ø§Ù‹ ØªØ£Ø«ÙŠØ± Ø¬Ø±Ø§ÙÙŠÙƒÙŠ)
  soundThrow: 'sounds/throw.mp3',
  soundHit:   'sounds/hit.mp3',
  soundBig:   'sounds/big_explosion.mp3'
};

/* =========================
  Ù„Ø¹Ø¨Ø© Phaser
   ========================= */
const config = {
  type: Phaser.AUTO,
  width: 900,
  height: 600,
  parent: 'game',
  physics: {
    default: 'arcade',
    arcade: { gravity: { y: 150 }, debug: false }
  },
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  scene: { preload, create, update }
};

let gameState = {
  cart: null,
  rocks: null,
  projectiles: null,
  cursors: null,
  score: 0,
  coins: 0,
  level: 1,
  weapon: 'pickaxe', // 'pickaxe' or 'dynamite'
  fireRate: 1.0, // Ø¶Ø±Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©
  coinPerRock: 5,
  lastShotTime: 0,
  rockSpeed: 180
};

const LS_KEY = 'miner_game_data_v1';

loadLocalData();

const game = new Phaser.Game(config);

function preload() {
  // Ù†Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø£Ø¹Ù„Ø§Ù‡
  // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªÙˆÙØ±Ø©ØŒ Ø­Ø§ÙˆÙ„ Ø£Ù† ØªØªØ£ÙƒØ¯ Ø¹Ù†Ø¯ Ø±ÙØ¹Ùƒ Ù„Ù„Ù…Ù„ÙØ§Øª
  this.load.image('background', ASSETS.background);
  this.load.image('cart', ASSETS.cart);
  this.load.image('rock', ASSETS.rock);
  this.load.image('pickaxe', ASSETS.pickaxe);
  this.load.image('dynamite', ASSETS.dynamite);
  this.load.image('explosion', ASSETS.explosion);

  // Ø£ØµÙˆØ§Øª (Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©)
  this.load.audio('soundThrow', ASSETS.soundThrow);
  this.load.audio('soundHit', ASSETS.soundHit);
  this.load.audio('soundBig', ASSETS.soundBig);
}

function create() {
  // Ø®Ù„ÙÙŠØ©
  this.add.rectangle(450,300,900,600,0x3b2a1f).setDepth(-2);
  try { this.add.image(450,300,'background').setScale(1.1).setDepth(-1); } catch(e){}

  // Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ø¹Ø±Ø¨Ø©
  gameState.cart = this.physics.add.sprite(450, 520, 'cart').setScale(0.8).setCollideWorldBounds(true);

  // Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
  gameState.rocks = this.physics.add.group(); // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù† Ù†Ø¶ÙŠÙ ØªØµØ§Ø¯Ù… Ø¯Ø§Ø®Ù„ÙŠ Ø¨ÙŠÙ†Ù‡Ø§
  gameState.projectiles = this.physics.add.group();

  // HUD ÙˆØ¹Ù†Ø§ØµØ± DOM
  updateHUD();

  // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹Ø§Øª (pointer + keyboard)
  gameState.cursors = this.input.keyboard.createCursorKeys();
  this.input.on('pointerdown', pointer => attemptShoot(this, pointer));

  // ÙÙŠØ²ÙŠØ§Ø¡: Ø±ØµØ§ØµØ© ØªØµØ·Ø¯Ù… Ø¨ØµØ®Ø±Ø©
  this.physics.add.collider(gameState.projectiles, gameState.rocks, (proj, rock) => {
    onRockHit(this, proj, rock);
  });

  // Ù„Ø§ Ù†Ø±ÙŠØ¯ ØªØµØ§Ø¯Ù… Ø§Ù„ØµØ®ÙˆØ± Ù…Ø¹ Ø¨Ø¹Ø¶Ù‡Ø§ => Ù„Ø§ ØªØ¶Ù collider between rocks

  // Ø¬ÙŠÙ„ Ø§Ù„ØµØ®ÙˆØ± Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø±
  this.time.addEvent({ delay: 1200, callback: () => spawnRock(this), callbackScope: this, loop: true });

  // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø§Ø­ ÙƒÙ„ 8 Ø«ÙˆØ§Ù†ÙŠ (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡)
  this.time.addEvent({ delay: 8000, callback: () => switchWeapon(), callbackScope: this, loop: true });

  // Ø²ÙŠØ§Ø¯Ø© ØµØ¹ÙˆØ¨Ø© (Ø³Ø±Ø¹Ø© Ø§Ù„ØµØ®ÙˆØ±) ÙƒÙ„ 12 Ø«Ø§Ù†ÙŠØ©
  this.time.addEvent({ delay: 12000, callback: () => increaseRockSpeed(), callbackScope: this, loop: true });

  // Ø¥Ù†Ø´Ø§Ø¡ textures Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø´Ø±Ø§Ø±Ø§Øª/Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ ØµÙˆØ±
  createParticleTextures(this);

  // Ø£ØµÙˆØ§Øª
  this.soundThrow = this.sound.add('soundThrow', { volume: 0.25, rate: 1 });
  this.soundHit = this.sound.add('soundHit', { volume: 0.3 });
  this.soundBig = this.sound.add('soundBig', { volume: 0.5 });

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø± DOM
  setupShopDOM(this);
}

function update(time, delta) {
  // Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨Ø©
  gameState.cart.setVelocityX(0);
  if (gameState.cursors.left.isDown) gameState.cart.setVelocityX(-260);
  else if (gameState.cursors.right.isDown) gameState.cart.setVelocityX(260);

  // ØªØµØ±Ù Ø§Ù„ØµØ®ÙˆØ±: Ù†Ø¶Ù…Ù† Ø£Ù†Ù‡Ø§ Ù„Ø§ ØªØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØªØ§Ø±ØªØ¯ Ù…Ù† Ø§Ù„Ø­ÙˆØ§Ù
  gameState.rocks.children.iterate(rock => {
    if (!rock || !rock.body) return;
    // Ø¥Ø°Ø§ Ø§Ù‚ØªØ±Ø¨Øª Ù…Ù† Ø§Ù„Ø­ÙˆØ§ÙØŒ ØªØªØ¹Ø§Ù…Ù„ ÙÙŠØ²ÙŠØ§Ø¡ world bounce Ù…Ø¹Ù‡Ø§
    // Ù„ÙƒÙ† ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£ÙÙ‚ÙŠØ© ØªØ­Øª Ø¹ØªØ¨Ø© Ù…Ø¹Ù‚ÙˆÙ„Ø©
    const maxV = gameState.rockSpeed;
    if (rock.body.velocity.x > maxV) rock.setVelocityX(maxV);
    if (rock.body.velocity.x < -maxV) rock.setVelocityX(-maxV);
    if (rock.body.velocity.y > maxV) rock.setVelocityY(maxV);
    if (rock.body.velocity.y < -maxV) rock.setVelocityY(-maxV);
  });

  // ØªØ­Ø¯ÙŠØ« HUD Ø¯ÙˆØ±ÙŠ (ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠØ± Ù„ÙƒÙ† Ù‡Ø°Ø§ Ø³Ù‡Ù„)
  updateHUD();
}

/* =========================
   ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
   ========================= */

function spawnRock(scene) {
  // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„ØµØ®ÙˆØ± Ø§Ù„Ù†Ø´Ø·Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  if (gameState.rocks.countActive(true) >= 20) return;

  const x = Phaser.Math.Between(60, config.width - 60);
  const y = Phaser.Math.Between(60, 220);
  const r = gameState.rocks.create(x, y, 'rock').setScale(0.75);
  r.setBounce(1);
  r.setCollideWorldBounds(true);
  // Ø³Ø±Ø¹Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ rockSpeed
  const vx = Phaser.Math.Between(-gameState.rockSpeed, gameState.rockSpeed);
  const vy = Phaser.Math.Between(-gameState.rockSpeed/2, gameState.rockSpeed);
  r.setVelocity(vx, vy);
  r.setData('hp', 1); // ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ³ÙŠØ¹ Ù„ÙƒÙ„ ØµØ®Ø±Ø© HP Ù„Ùˆ Ø£Ø±Ø¯Øª
  r.setData('id', Date.now() + Math.random());
}

function attemptShoot(scene, pointer) {
  // ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù†Ø§Ø± Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ fireRate (Ø¶Ø±Ø¨Ø§Øª/Ø«Ø§Ù†ÙŠØ©)
  const now = scene.time.now;
  const cooldown = 1000 / gameState.fireRate;
  if (now - gameState.lastShotTime < cooldown) return;
  gameState.lastShotTime = now;
  shoot(scene);
}

function shoot(scene) {
  // ØµÙˆØª Ø§Ù„Ø±Ù…ÙŠ
  try { scene.soundThrow.play(); } catch(e) {}
  const proj = gameState.projectiles.create(gameState.cart.x, gameState.cart.y - 30, gameState.weapon).setScale(0.6);
  proj.setVelocityY(-500);
  proj.setCollideWorldBounds(false);
  // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø±ØµØ§ØµØ© ØªØ¯Ù…Ø± Ù†ÙØ³Ù‡Ø§ Ø¨Ø¹Ø¯ 2.5 Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªØµØ¨ Ø´ÙŠØ¦Ù‹Ø§
  scene.time.delayedCall(2500, () => { if (proj && proj.active) proj.destroy(); });

  // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ ØµØºÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…ÙŠ
  if (gameState.weapon === 'pickaxe') {
    // Ø´Ø±Ø§Ø±Ø§Øª Ø£Ù…Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨Ø©
    createSparkEffect(scene, gameState.cart.x, gameState.cart.y - 50, 8, 300);
  } else {
    // Ø¯ÙŠÙ†Ø§Ù…ÙŠØª: ÙˆÙ…ÙŠØ¶ Ù‚ØµÙŠØ± Ø£Ù…Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨Ø©
    createBigMuzzle(scene, gameState.cart.x, gameState.cart.y - 50);
  }
}

function onRockHit(scene, projectile, rock) {
  // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø±ØµØ§ØµØ©
  try { projectile.destroy(); } catch(e){}

  // ØªØ£Ø«ÙŠØ± ØµÙˆØª ÙˆÙ…Ø±Ø¦ÙŠ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„Ø§Ø­
  if (gameState.weapon === 'pickaxe') {
    try { scene.soundHit.play(); } catch(e){}
    createSparkEffect(scene, rock.x, rock.y, 12, 400);
  } else {
    try { scene.soundBig.play(); } catch(e){}
    createExplosion(scene, rock.x, rock.y);
  }

  // Ù…Ù†Ø­ Ù†Ù‚Ø§Ø· ÙˆÙ†Ù‚ÙˆØ¯
  const pointsGain = (gameState.weapon === 'pickaxe') ? 10 : 20;
  gameState.score += pointsGain;
  gameState.coins += gameState.coinPerRock;

  // ØªØ²ÙˆÙŠØ¯ ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙˆÙ‰: Ø¹Ù†Ø¯ ÙƒÙ„ 100 Ù†Ù‚Ø·Ø© = Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯
  const nextLevelThreshold = gameState.level * 100;
  if (gameState.score >= nextLevelThreshold) {
    // ØªÙˆÙ‚Ù Ù…Ø¤Ù‚Øª Ù„Ù„Ø¹Ø¨Ø© ÙˆÙØªØ­ Ø§Ù„Ù…ØªØ¬Ø±
    gameState.level++;
    // ØªØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¬Ø±
    saveLocalData();
    openShop();
  }

  // ØªØ¯Ù…ÙŠØ± Ø§Ù„ØµØ®Ø±Ø©
  try { rock.destroy(); } catch(e){}
  saveLocalData();
}

/* =========================
   ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© ÙˆØµÙˆØªÙŠØ© (Ø´Ø±Ø§Ø±Ø§Øª / Ø§Ù†ÙØ¬Ø§Ø±)
   ========================= */

function createParticleTextures(scene) {
  // Ù†Ø±Ø³Ù… texture ØµØºÙŠØ± Ù„Ù„Ø´Ø±Ø§Ø±Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
  if (!scene.textures.exists('spark')) {
    const g = scene.add.graphics();
    g.fillStyle(0xffdd66, 1);
    g.fillCircle(4,4,4);
    g.generateTexture('spark', 8, 8);
    g.destroy();
  }
  if (!scene.textures.exists('bigBlast')) {
    const g2 = scene.add.graphics();
    g2.fillStyle(0xff9933, 1);
    g2.fillCircle(16,16,16);
    g2.generateTexture('bigBlast', 32, 32);
    g2.destroy();
  }
}

function createSparkEffect(scene, x, y, count=10, lifespan=500) {
  const particles = scene.add.particles('spark');
  const emitter = particles.createEmitter({
    x:x, y:y,
    speed: { min: 80, max: 220 },
    angle: { min: -160, max: -20 },
    gravityY: 300,
    lifespan: lifespan,
    quantity: count,
    scale: { start: 0.6, end: 0 },
    blendMode: 'ADD'
  });
  scene.time.delayedCall(lifespan, () => { particles.destroy(); });
}

function createBigMuzzle(scene, x, y) {
  const flash = scene.add.rectangle(x, y, 60, 30, 0xffe6b3).setAlpha(0.9).setDepth(5);
  scene.tweens.add({ targets: flash, alpha:0, duration:180, ease:'Cubic.easeOut', onComplete: ()=>flash.destroy() });
}

function createExplosion(scene, x, y) {
  const particles = scene.add.particles('bigBlast');
  const emitter = particles.createEmitter({
    x:x, y:y,
    speed: { min: 100, max: 400 },
    angle: { min: 0, max: 360 },
    gravityY: 600,
    lifespan: 700,
    scale: { start: 1.0, end: 0 },
    quantity: 30,
    blendMode: 'ADD'
  });
  // Ø§Ù‡ØªØ²Ø§Ø² Ø£Ù‚ÙˆÙ‰ Ù„Ù„Ø´Ø§Ø´Ø©
  scene.cameras.main.shake(350, 0.02);
  scene.time.delayedCall(700, () => { particles.destroy(); });
}

/* =========================
   ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ø²Ø¯ÙŠØ§Ø¯ Ø³Ø±Ø¹Ø© Ø§Ù„ØµØ®ÙˆØ±
   ========================= */

function switchWeapon() {
  gameState.weapon = (gameState.weapon === 'pickaxe') ? 'dynamite' : 'pickaxe';
  updateWeaponBox();
}

function increaseRockSpeed() {
  gameState.rockSpeed += 25;
  // Ù†Ø²ÙŠØ¯ Ø³Ø±Ø¹Ø§Øª Ø§Ù„ØµØ®ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹ Ø¨Ø´ÙƒÙ„ Ø·ÙÙŠÙ
  gameState.rocks.children.iterate(r => {
    if (r && r.body) {
      const vx = Phaser.Math.Between(-gameState.rockSpeed, gameState.rockSpeed);
      const vy = Phaser.Math.Between(-gameState.rockSpeed/2, gameState.rockSpeed);
      r.setVelocity(vx, vy);
    }
  });
}

/* =========================
   Ù…ØªØ¬Ø± (Shop) â€” DOM
   ========================= */

function setupShopDOM(scene) {
  const shopOverlay = document.getElementById('shopOverlay');
  const buyFireRateBtn = document.getElementById('buyFireRate');
  const buyCoinBtn = document.getElementById('buyCoinPerRock');
  const continueBtn = document.getElementById('continueGame');
  const skipBtn = document.getElementById('skipShop');

  // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØ¬Ø±
  function refreshShopDisplay() {
    document.getElementById('shopLevel').textContent = gameState.level;
    document.getElementById('fireRateVal').textContent = gameState.fireRate.toFixed(1);
    document.getElementById('coinPerRockVal').textContent = gameState.coinPerRock;
    // Ø­Ø³Ø§Ø¨ ØªÙƒØ§Ù„ÙŠÙ Ù…Ø¨Ø³Ø·Ø© (ØªØµØ§Ø¹Ø¯ÙŠØ©)
    const costFire = Math.round(50 * Math.pow(1.6, (gameState.fireRate - 1)/0.5));
    const costCoin = Math.round(60 * Math.pow(1.5, (gameState.coinPerRock - 5)/2));
    document.getElementById('buyFireRateCost').textContent = costFire;
    document.getElementById('buyCoinPerRockCost').textContent = costCoin;
    buyFireRateBtn.disabled = (gameState.coins < costFire);
    buyCoinBtn.disabled = (gameState.coins < costCoin);
  }

  buyFireRateBtn.addEventListener('click', () => {
    const cost = parseInt(document.getElementById('buyFireRateCost').textContent);
    if (gameState.coins >= cost) {
      gameState.coins -= cost;
      gameState.fireRate = +(gameState.fireRate + 0.5).toFixed(1);
      saveLocalData();
      refreshShopDisplay();
      updateHUD();
    }
  });

  buyCoinBtn.addEventListener('click', () => {
    const cost = parseInt(document.getElementById('buyCoinPerRockCost').textContent);
    if (gameState.coins >= cost) {
      gameState.coins -= cost;
      gameState.coinPerRock += 2;
      saveLocalData();
      refreshShopDisplay();
      updateHUD();
    }
  });

  continueBtn.addEventListener('click', () => {
    closeShop();
  });

  skipBtn.addEventListener('click', () => {
    closeShop();
  });

  // Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ø§Ù„Ù…ØªØ¬Ø± (Ø³ØªÙˆÙ‚Ù Ù„Ø¹Ø¨Ø© Phaser Ù…Ø¤Ù‚ØªÙ‹Ø§)
  window.openShop = function() {
    // Ø¥Ø¸Ù‡Ø§Ø± overlay
    shopOverlay.style.visibility = 'visible';
    // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø´Ù‡Ø¯
    scene.scene.pause();
    refreshShopDisplay();
  };

  window.closeShop = function() {
    shopOverlay.style.visibility = 'hidden';
    scene.scene.resume();
    saveLocalData();
    updateHUD();
  };

  // Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
  refreshShopDisplay();
}

/* =========================
   HUD Ùˆ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
   ========================= */

function updateHUD() {
  document.getElementById('scoreBox').textContent = 'Ø§Ù„Ù†Ù‚Ø§Ø·: ' + gameState.score;
  document.getElementById('coinsBox').textContent = 'Ø§Ù„Ù†Ù‚ÙˆØ¯: ' + gameState.coins;
  document.getElementById('levelBox').textContent = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ' + gameState.level;
  updateWeaponBox();
}

function updateWeaponBox() {
  document.getElementById('weaponBox').textContent = 'Ø§Ù„Ø³Ù„Ø§Ø­: ' + (gameState.weapon === 'pickaxe' ? 'ÙØ£Ø³' : 'Ø¯ÙŠÙ†Ø§Ù…ÙŠØª');
}

function saveLocalData() {
  const payload = {
    score: gameState.score,
    coins: gameState.coins,
    level: gameState.level,
    fireRate: gameState.fireRate,
    coinPerRock: gameState.coinPerRock,
    rockSpeed: gameState.rockSpeed,
    weapon: gameState.weapon
  };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
}

function loadLocalData() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    gameState.score = data.score || 0;
    gameState.coins = data.coins || 0;
    gameState.level = data.level || 1;
    gameState.fireRate = data.fireRate || 1.0;
    gameState.coinPerRock = data.coinPerRock || 5;
    gameState.rockSpeed = data.rockSpeed || 180;
    gameState.weapon = data.weapon || 'pickaxe';
  } catch(e){ console.warn('Failed to load local data', e); }
}

/* helper Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† localData Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù†Ø¯Ø¹ÙˆÙ‡Ø§ Ø£Ø¹Ù„Ø§Ù‡) */
function loadLocalData() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);
    if (data.score !== undefined) gameState.score = data.score;
    if (data.coins !== undefined) gameState.coins = data.coins;
    if (data.level !== undefined) gameState.level = data.level;
    if (data.fireRate !== undefined) gameState.fireRate = data.fireRate;
    if (data.coinPerRock !== undefined) gameState.coinPerRock = data.coinPerRock;
    if (data.rockSpeed !== undefined) gameState.rockSpeed = data.rockSpeed;
    if (data.weapon !== undefined) gameState.weapon = data.weapon;
  } catch(e){}
}

/* =========================
   ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø£ØµÙˆØ§Øª
   =========================
   â€¢ Ø¶Ø¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ Ø¨Ø§Ø³Ù… images/ (ÙÙŠ Ù†ÙØ³ Ù…Ø¬Ù„Ø¯ index.html):
     - images/background.png    â† Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
     - images/cart.png          â† ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø±Ø¨Ø© (Ù…Ù‚Ø§Ø³ ØªÙ‚Ø±ÙŠØ¨ÙŠ 200x100)
     - images/rock.png          â† ØµÙˆØ±Ø© Ø§Ù„ØµØ®Ø±Ø© (Ù…Ø±Ø¨Ø¹Ø© Ø£Ùˆ Ø¯Ø§Ø¦Ø±ÙŠØ©)
     - images/pickaxe.png       â† Ø£ÙŠÙ‚ÙˆÙ†Ø©/ØµÙˆØ±Ø© Ù„Ù„ÙØ£Ø³ (ØµØºÙŠØ±Ø©)
     - images/dynamite.png      â† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠØª
     - images/explosion.png     â† ØµÙˆØ±Ø© Ø§Ù†ÙØ¬Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

   â€¢ Ø¶Ø¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ sounds/:
     - sounds/throw.mp3
     - sounds/hit.mp3
     - sounds/big_explosion.mp3

   â€¢ Ø¥Ø°Ø§ Ù„Ù… ØªØ¶Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø³ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø±Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆÙ„ÙƒÙ† Ù‚Ø¯ ØªØ±Ù‰ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
     (Ù„Ø°Ù„Ùƒ Ø£Ù†ØµØ­ Ø¨ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø«Ù… ØªØ¬Ø±Ø¨).

   â€¢ Ø¨Ø¹Ø¯ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ø§Ø±ÙØ¹ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¥Ù„Ù‰ GitHub Pages Ø£Ùˆ Netlify.
   ========================= */

</script>
</body>
</html>
